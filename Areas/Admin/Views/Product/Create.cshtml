@model webbanhang.ViewModels.ProductViewModel

@{
    ViewData["Title"] = "Thêm sản phẩm mới";
}

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Thêm sản phẩm mới
                </h4>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" enctype="multipart/form-data" id="productForm">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <!-- Basic Product Info -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <label asp-for="ProductName" class="form-label fw-bold">
                                    <i class="fas fa-tag me-2 text-success"></i>Tên sản phẩm
                                </label>
                                <input asp-for="ProductName" class="form-control form-control-lg"
                                    placeholder="Nhập tên sản phẩm..." />
                                <span asp-validation-for="ProductName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <label asp-for="CategoryId" class="form-label fw-bold">
                                    <i class="fas fa-list-alt me-2 text-success"></i>Danh mục
                                </label>
                                <select asp-for="CategoryId" asp-items="Model.Categories"
                                    class="form-select form-select-lg">
                                    <option value="">Chọn danh mục</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Description" class="form-label fw-bold">
                            <i class="fas fa-align-left me-2 text-success"></i>Mô tả sản phẩm
                        </label>
                        <textarea asp-for="Description" class="form-control" rows="4"
                            placeholder="Nhập mô tả chi tiết về sản phẩm..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <!-- Price and Variants Section -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-4">
                                <label asp-for="Price" class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign me-2 text-success"></i>Giá (VNĐ)
                                </label>
                                <input asp-for="Price" class="form-control form-control-lg" type="number" step="1000"
                                    placeholder="Nhập giá sản phẩm..." />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-palette me-2 text-success"></i>Màu sắc
                                </label>
                                <select asp-for="ColorIds" asp-items="Model.Colors" class="form-select" multiple>
                                    <option value="">Chọn màu sắc</option>
                                </select>
                                <div class="form-text">Giữ Ctrl để chọn nhiều màu</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-ruler me-2 text-success"></i>Kích thước
                                </label>
                                <select asp-for="SizeIds" asp-items="Model.Sizes" class="form-select" multiple>
                                    <option value="">Chọn kích thước</option>
                                </select>
                                <div class="form-text">Giữ Ctrl để chọn nhiều size</div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-images me-2 text-success"></i>Hình ảnh sản phẩm
                        </label>
                        <div class="border rounded p-3 bg-light">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="productImages" name="Images" multiple
                                    accept=".jpg,.jpeg,.png" onchange="previewImages(this)">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Chọn nhiều ảnh (JPG, PNG). Ảnh đầu tiên sẽ làm ảnh đại diện.
                                </div>
                            </div>

                            <!-- Image Preview -->
                            <div id="imagePreview" class="row g-2" style="display: none;">
                                <!-- Preview images will be shown here -->
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-3 justify-content-end">
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại
                        </a>
                        <button type="submit" class="btn btn-success" id="createBtn">
                            <i class="fas fa-save me-2"></i>Tạo sản phẩm
                        </button>d
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Product Preview Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Xem trước sản phẩm
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div id="previewThumbnail"
                        class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center mb-3"
                        style="height: 150px;">
                        <i class="fas fa-image text-secondary fa-3x"></i>
                    </div>
                    <h6 id="previewName" class="text-muted">Tên sản phẩm...</h6>
                    <span id="previewCategory" class="badge bg-secondary">Chọn danh mục</span>
                </div>

                <div class="border-top pt-3">
                    <p id="previewDescription" class="small text-muted mb-0">
                        Mô tả sản phẩm sẽ hiển thị ở đây...
                    </p>
                </div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card shadow-sm mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Hướng dẫn
                </h6>
            </div>
            <div class="card-body">
                <ol class="mb-0 small">
                    <li class="mb-2">Nhập thông tin cơ bản của sản phẩm</li>
                    <li class="mb-2">Upload hình ảnh (tối đa 10 ảnh)</li>
                    <li class="mb-2">Sau khi tạo, bạn sẽ chuyển đến trang chỉnh sửa</li>
                    <li class="mb-0">Ở trang chỉnh sửa, thêm màu sắc, kích thước và giá</li>
                </ol>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Live preview functionality
        document.getElementById('ProductName').addEventListener('input', function (e) {
            const previewName = document.getElementById('previewName');
            const value = e.target.value.trim();
            previewName.textContent = value || 'Tên sản phẩm...';
            previewName.className = value ? 'text-dark' : 'text-muted';
        });

        document.getElementById('CategoryId').addEventListener('change', function (e) {
            const previewCategory = document.getElementById('previewCategory');
            const selectedOption = e.target.options[e.target.selectedIndex];
            const categoryText = selectedOption.text;

            if (e.target.value) {
                previewCategory.textContent = categoryText;
                previewCategory.className = 'badge bg-success';
            } else {
                previewCategory.textContent = 'Chọn danh mục';
                previewCategory.className = 'badge bg-secondary';
            }
        });

        document.getElementById('Description').addEventListener('input', function (e) {
            const previewDescription = document.getElementById('previewDescription');
            const value = e.target.value.trim();
            previewDescription.textContent = value || 'Mô tả sản phẩm sẽ hiển thị ở đây...';
        });

        // Image preview functionality
        function previewImages(input) {
            const previewContainer = document.getElementById('imagePreview');
            const previewThumbnail = document.getElementById('previewThumbnail');

            previewContainer.innerHTML = '';

            if (input.files && input.files.length > 0) {
                previewContainer.style.display = 'block';

                // Show first image as thumbnail in preview card
                const firstFile = input.files[0];
                const firstReader = new FileReader();
                firstReader.onload = function (e) {
                    previewThumbnail.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 150px; object-fit: cover;">`;
                };
                firstReader.readAsDataURL(firstFile);

                // Show all images in preview grid
                Array.from(input.files).slice(0, 10).forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const imageDiv = document.createElement('div');
                            imageDiv.className = 'col-4';
                            imageDiv.innerHTML = `
                                            <div class="position-relative">
                                                <img src="${e.target.result}" class="img-fluid rounded" style="aspect-ratio: 1; object-fit: cover;">
                                                ${index === 0 ? '<span class="position-absolute top-0 start-0 badge bg-warning m-1"><i class="fas fa-star"></i></span>' : ''}
                                            </div>
                                        `;
                            previewContainer.appendChild(imageDiv);
                        };
                        reader.readAsDataURL(file);
                    }
                });

                if (input.files.length > 10) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'col-12 text-center mt-2';
                    moreDiv.innerHTML = `<small class="text-muted">+${input.files.length - 10} ảnh khác (chỉ upload 10 ảnh đầu)</small>`;
                    previewContainer.appendChild(moreDiv);
                }
            } else {
                previewContainer.style.display = 'none';
                previewThumbnail.innerHTML = '<i class="fas fa-image text-secondary fa-3x"></i>';
            }
        }

        // Form submission handling
        document.getElementById('productForm').addEventListener('submit', function (e) {
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo...';
        });

        // Auto focus
        document.getElementById('ProductName').focus();
    </script>
}

@section Styles {
    <style>
        .card {
            border: none;
            border-radius: 12px;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.1);
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
        }

        .card-header {
            border-radius: 12px 12px 0 0 !important;
        }

        .border-info {
            border-width: 2px !important;
        }

        #imagePreview img {
            transition: transform 0.2s;
        }

        #imagePreview img:hover {
            transform: scale(1.05);
        }

        .position-relative .badge {
            font-size: 0.7em;
        }
    </style>
}
